---
layout:     post
title:      ISP架构详解
subtitle:   3rd blog
date:       2024-10-05
author:     Qinglong
header-img: img/post_light.jpg
catalog: true
tags:
    - ISP process
---

## 3A详解
图像处理领域中的"3A"通常指的是自动曝光(Auto Exposure, AE)、自动白平衡(Auto White Balance, AWB)和自动对焦(Auto Focus, AF)这三个关键算法，它们共同作用于图像信号处理器(ISP, Image Signal Processor)中，以优化最终成像质量。下面简要概述这些功能的工作原理：  
自动曝光(AE)
自动曝光的主要目的是确保在不同光照条件下拍摄的照片都能达到合适的亮度。它通过调整快门速度、光圈大小以及ISO感光度来控制进入传感器的光线量。AE算法会分析场景的亮度分布，比如识别出图像中的最亮和最暗部分，然后计算出一个合适的曝光值，使得画面既不过曝也不欠曝，细节得以保留。 

自动白平衡(AWB)
自动白平衡的任务是校正光源色温对图像色彩的影响，使白色物体在任何光源下看起来都是真正的白色。这是因为不同光源（如日光、荧光灯、白炽灯）的色温不同，会导致相机捕捉到的图像偏黄或偏蓝。AWB算法通过分析画面中被认为是中性灰色或白色的部分，然后调整红、绿、蓝三原色的比例，以达到颜色的真实还原。  

自动对焦(AF)
自动对焦系统负责快速准确地锁定拍摄对象，确保图像清晰。常见的AF方法包括对比度检测AF和相位检测AF。对比度检测AF通过分析图像中像素之间的对比度变化来判断焦点位置，当对比度最高时认为是对焦最准确的点。相位检测AF则利用专门的传感器或像素，直接测量光线相位差，更快地确定镜头需要移动的距离，实现快速对焦。

### 自动曝光(AE)
不同场景下，光照的强度有着很大的差别。人眼有着自适应的能力因此可以很快的调整，使自己可以感应到合适的亮度。而图像传感器却不具有这种自适应能力，因此必须使用自动曝光功能来确保拍摄的照片获得准确的曝光从而具有合适的亮度。  
处理模块名称：AEC（Automatic Exposure Control）----自动曝光  
1. 处理原理：
自动曝光的实现一般包括三个步骤：  
1）光强测量。光强测量的过程是利用图像的曝光信息来获得当前光照信息的过程。可以统计图像的全部像素，也可以统计图像中间部分、也可以将图像分成不同部分且每部分赋予不同权重。  
2）场景分析。场景分析是指为了获得当前光照的特殊情况而进行的处理，比如有没有背光照射或者正面强光等场景下。对这些信息的分析，可以提升图像传感器的易用性，并且能大幅度提高图像的质量，这是自动曝光中最为关键的技术。目前常用的场景分析的技术主要有模糊逻辑和人工神经网络算法。这些算法比起固定分区测光算法具有更高的可靠性，主要是因为在模糊规则制定或者神经网络的训练过程中已经考虑了各种不同光照条件。  
3）曝光补偿。在完成了光强测量和场景分析之后，就要控制相应的参数使得曝光调节生效。主要是通过设定曝光时间和曝光增益来实现的。

2. 处理流程：实时计算，且需要提前调校。
3. 处理效果：自动曝光的要求总是不断提高的。

### 自动对焦（AF）
处理模块名称：AF (Auto Focus) ---- 自动对焦
1. 处理原理：  
AF算法的基本步骤是先判断图像的模糊程度，通过合适的模糊度评价函数求得采集的每一副图像的评价值, 然后通过搜索算法得到一系列评价值的峰值, 最后通过电机驱动将采集设备调节到峰值所在的位置, 得到最清晰的图像。    
对焦评价函数:  
评价函数有很多种, 主要考虑的图像因素有图像频率(清晰的图像纹理多, 高频分布较多), 还有图像的灰度分量的分布(图像对应的灰度图的分量分布范围越大,说明图像的细节较多, 反应的图像的清晰程度)  
常用的搜索算法有爬山算法, 搜索窗口有黄金分割点对焦嵌套窗口等.
2. 处理流程：实时计算，且需要提前调校。
3. 处理效果：大家体验一下自己的手机摄像头的对焦体验，大部分时间是准的。  

### 自动白平衡（AWB）
人类的视觉系统有一定的颜色恒常性特点，不会受到光源颜色的影响。实际生活中，不论是晴天、阴天、室内白炽灯或日光灯下，人们所看到的白色物体总是是白色的，这就是视觉修正的结果。人脑对物体的颜色有一定先验知识，可识别物体并且更正这种色差。
但是Sensor不具备这样的特点，比如一张白纸，在不同光线下，Sensor输出的是不同颜色，在低色温下偏黄，在高色温下偏蓝。如白炽灯照明下拍出的照片易偏黄；而在户外日光充足则拍摄出来景物也会偏蓝。  
我们就需要，让不同色温光线条件下白色物体，Sensor的输出都转换为更接近白色。  
处理模块名称：AWB（Automatic White Balance）------自动白平衡  
1. 处理原理：比较常用的WEB算法有灰度世界、完美反射法等。
灰度世界（Gray World）算法基于一个假设：平均来讲，世界是灰色的。所以，白平衡就是调整R/B增益，达到R、G、B 相等。
白平衡有3个步骤：  
（1）检测色温，如果手工调节，就知道图像中什么位置是白色物体了，色温容易检测；如果是自动调节，就需要估计出（猜出）图像中的白色位置，这是最重要的一环；
实际计算中为了实时操作，减少计算量，通常选取某个特定区域(如图像中央)像素进行计算。但若图像颜色较为单一或选定区域正好落入大的色块（红光下的白墙），以上算法求得的色温会非常不准确。为此，必须根据一定的约束条件，挑选出白色像素来计算色差。  
（2）计算增益，计算R和B要调整的增益；调整增益将Cb和Cr调整到0 (或接近0)的两个系数，即R=G=B。  
（3）色温矫正，根据增益调整整幅图片的色温。
2. 处理流程：自动校正。
3. 处理效果：现阶段大多数的数码相机、拍照手机的白平衡的功能都已相当准确。  

白平衡对色彩效果影响很大，一个好的算法能够使色彩效果更逼真，也可以利用白平衡达到艺术效果。
